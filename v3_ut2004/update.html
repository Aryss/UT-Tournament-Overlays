<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Update Page</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">         
    <style>
        body { font-family: Jost, sans-serif; color: white; background-color: #1d1f26;   scrollbar-width: thin; scrollbar-color: #f3ae05 #1d1f2600; }
        *::-webkit-scrollbar { width: 5px; }
        *::-webkit-scrollbar-track { background: #1d1f2600; }
        *::-webkit-scrollbar-thumb { background-color: #f3ae05; border-radius: 20px; border: 3px solid orange; }
        .container { width: 420px; margin: 10px auto; }
        label { display: block; margin-top: 10px; }
        select { width: 100%; padding: 5px; margin-top: 5px; }
        input { width: 95%; padding: 5px; margin-top: 5px; }        
        button { padding: 10px; margin: 10px 0; width: 100%; font-weight: 600; background-color: #17641e; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #4CAF50; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding-top: 5px; padding-bottom: 5px; text-align: center;}
        th {background-color: #44474e; font-weight: 300;}
        .delete-btn { color: rgb(255, 255, 255); cursor: pointer; padding-left: 5px; padding-right: 5px; }
        .row { display: flex; justify-content: space-between; margin-top: 10px; }
        .flex {display: flex;}
        .half-width { width: 48%; }
        .score-btn-block { width: 50%; display: flex; flex-direction: row;}
        .score-btn { color: #17641e; cursor: pointer; padding-left: 5px; padding-right: 5px; max-width: 50%; height: 60px; font-size: 30px; color: aliceblue; margin-left: 10px; margin-right: 10px;}
        .scores { display: flex; justify-content: space-between; margin-top: 10px; }
        .score-half { width: 48%; }
        .filler {width: 100%;}
        .checkbox-row { display: flex; flex-direction: row; }
        .checkbox {width: 40px;}
        #short_names {width:unset;}
        #winby_col {width: 80px}
        #delete_col {width: 25px}                
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <span id="to_home" class="delete-btn material-symbols-outlined">home</span>
        <span class="filler"></span>
        <span id="bans" class="delete-btn material-symbols-outlined">block</span>
<!-- <span id="to_scoreboard" class="delete-btn material-symbols-outlined">dataset</span> -->        
    </div>
    <!-- Match Type -->
    <div class="row">
        <div class="half-width">
            <label for="matchType">Match Type</label>
            <select id="matchType">
            </select>
        </div>
        <div class="half-width">
            <label for="attack">Team on Attack</label>
            <select id="attack">
                <option value="0">Left</option>
                <option value="1">Right</option>
                <option value="2">Non-AS mode</option>
            </select>
        </div>
    </div>

    <!-- Match Number and Current Map on the same line -->
    <div class="row">
        <div class="half-width">
            <label for="matchNumber">Match Number</label>
            <select id="matchNumber">
            </select>
        </div>

        <div class="half-width">
            <label for="currentMap">Current Map</label>
            <select id="currentMap"></select>
        </div>
    </div>

    <!-- Team A and Team B on the same line -->
    <div class="row">
        <div class="half-width">
            <label for="teamA">Team A</label>
            <select id="teamA"></select>
        </div>

        <div class="half-width">
            <label for="teamB">Team B</label>
            <select id="teamB"></select>
        </div>
    </div>

    <!-- Team A Score and Team B Score on the same line, under Team A and Team B -->
    <div class="scores">
        <div class="score-half">
            <span id="ScoreLabelA">Team A Score</label>
            <select id="teamAScore">
                <option value=0>0</option>
                <option value=1>1</option>
                <option value=2>2</option>
                <option value=3>3</option>
                <option value=4>4</option>
            </select>
        </div>

        <div class="score-half">
            <span id="ScoreLabelB">Team B Score</label>
            <select id="teamBScore">
                <option value=0>0</option>
                <option value=1>1</option>
                <option value=2>2</option>
                <option value=3>3</option>
                <option value=4>4</option>
            </select>
        </div>
    </div>
    <div id="score-buttons" class="flex">
        <div class="score-btn-block" id="score-buttons-A">
            <button class="score-btn" id="score-increment-A">+</button>
            <button class="score-btn" id="score-decrement-A">-</button>
        </div>
        <div class="score-btn-block" id="score-buttons-B">
            <button class="score-btn" id="score-decrement-B">-</button>
            <button class="score-btn" id="score-increment-B">+</button>
        </div>
    </div>
    <div class="checkbox-row">
        <div><input class="checkbox" type="checkbox" id="short_names" name="" unchecked /><span>Short names</span>&nbsp;&nbsp;&nbsp;</div>
        <div><input class="checkbox" type="checkbox" id="swap" name="" unchecked /><span>Swap teams</span></div>
    </div>
    <!-- Buttons -->
    <button id="updateButton">UPDATE MATCH</button>
    <!-- Win Type -->
    <label for="winType">Win Type</label>
    <select id="winType">
        <option value="OBJ1">Team A by OBJ</option>
        <option value="OBJ2">Team B by OBJ</option>
        <option value="TIME1">Team A by TIME</option>
        <option value="TIME2">Team B by TIME</option>        
    </select>
    <br />
    <button id="resultButton">ADD RESULT</button>

    <!-- Matches Table -->
    <h3>Results</h3>
    <table>
        <thead>
            <tr>
                <th>MATCH</th>
                <th>MAP</th>
                <th>SCORE</th>
                <th id="winby_col">WIN BY</th>
                <th id="delete_col">Â </th>
            </tr>
        </thead>
        <tbody id="matchTable"></tbody>
    </table>
</div>

<script>
// const apiUrl = 'http://localhost:5000'; // Base URL for the API
const apiUrl = '';
const matchJSON = {
        match_type: 3,
        current_map: '',
        match_no: 1,
        short_names: false,
        swap: false,
        teams: [
            { name: '', id: 0, score: 0 },
            { name: '', id: 1, score: 0 }
        ],
    };

let tournamentData = {};
var teamA = '';
var teamB = '';

// Helper function to make API requests
const apiRequest = async (method, endpoint, data = null) => {
    const options = {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
    };

    if (data) {
        options.body = JSON.stringify(data);
    }

    const response = await fetch(`${apiUrl}${endpoint}`, options);
    return response.json();
};

const fetchMatchData = async () => {
    const response = await fetch('/static/match.json');
    const matchData = await response.json();

    // Populate controls with data from match.json
    populateControls(matchData);
};


function GetTeamIDbyName(team_name) {
    tournamentData.teams.forEach(team => {
        if (team.name == team_name)
            return team.id; 
    });
}

const GetTeamNamebyID = async (team_id) => {
    tname = await apiRequest('GET', '/team/name/' + team_id);
    return tname.name;
}

// Fetch existing matches from the API on page load
const fetchMatches = async () => {
    const matches = await apiRequest('GET', '/matches');
    const matchTable = document.getElementById('matchTable');
    matchTable.innerHTML = ''; // Clear existing rows before populating

    matches.forEach(match => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${match.match_number}</td>
            <td>${match.map_name}</td>
            <td>${match.map_score}</td>
            <td>${match.win_type}</td>
            <td><span class="delete-btn material-symbols-outlined" onclick="deleteMatch(${match.match_number})">delete</span></td>
        `;
        matchTable.appendChild(row);
    });
};


// Delete match from history via API
const deleteMatch = async (matchNumber) => {
    const response = await apiRequest('DELETE', `/match/${matchNumber}`);
    if (!response.message) {
        alert('Error deleting match!');  // Handle any potential errors
    }
    fetchMatches(); // Refresh the match table after deletion
};

// Populate dropdowns from tournament.json
const populateDropdowns = async () => {

// Populate Match Type
const matchTypeSelect = document.getElementById('matchType');
const matchTypes = ["3", "5", "7"];
matchTypes.forEach(type => {
    const option = document.createElement('option');
    option.value = type;
    option.textContent = `Best of ${type}`;
    matchTypeSelect.appendChild(option);
});

// Populate Match Number
const matchNumberSelect = document.getElementById('matchNumber');
for (let i = 1; i <= 7; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    matchNumberSelect.appendChild(option);
}

// Populate Teams
const teamASelect = document.getElementById('teamA');
const teamBSelect = document.getElementById('teamB');
tournamentData.teams.forEach(team => {
    const optionA = document.createElement('option');
    optionA.value = team.id; 
    optionA.textContent = team.name;
    teamASelect.appendChild(optionA);

    const optionB = document.createElement('option');
    optionB.value = team.id; 
    optionB.textContent = team.name;
    teamBSelect.appendChild(optionB);
});

// Populate Current Map
const currentMapSelect = document.getElementById('currentMap');
tournamentData.maps.forEach(map => {
    const option = document.createElement('option');
    option.value = map.id; // Assuming the map ID is used for the value
    option.textContent = map.name;
    currentMapSelect.appendChild(option);
});

};

const loadTournamentData = async () => {
    tournamentData = await apiRequest('GET', '/tournament');
    populateDropdowns();
    fetchMatches();
}

// Handle update button click to update matchJSON via API
document.getElementById('updateButton').addEventListener('click', async () => {
    
    const matchType = document.getElementById('matchType').value;
    const match_no = document.getElementById('matchNumber').value;
    const teamAScore = document.getElementById('teamAScore').value;
    const teamBScore = document.getElementById('teamBScore').value;
    const short_names = document.getElementById('short_names').checked;    
    const swap = document.getElementById('swap').checked;
    const teamA_id = document.getElementById('teamA').value;
    const teamB_id = document.getElementById('teamB').value;
    const teamA_name = await GetTeamNamebyID(teamA_id);
    const teamB_name = await GetTeamNamebyID(teamB_id);
    const attack = document.getElementById('attack').value;
    const currentMap = document.getElementById('currentMap').value;
    console.log(document.getElementById('short_names').checked);
    matchJSON.match_type = parseInt(matchType);
    matchJSON.match_no = match_no;
    matchJSON.attack = attack;
    matchJSON.short_names = short_names;
    matchJSON.swap = swap;
    matchJSON.teams[0] = { id: teamA_id, team_name: teamA_name, score: parseInt(teamAScore) };
    matchJSON.teams[1] = { id: teamB_id, team_name: teamB_name, score: parseInt(teamBScore) };
    matchJSON.current_map = currentMap;

    // Send updated matchJSON to the API
    console.log(matchJSON);
    const response = await apiRequest('POST', '/match', matchJSON);
});

document.getElementById('score-increment-A').addEventListener('click', async () => {
    document.getElementById('teamAScore').value = Math.min(parseInt(document.getElementById('teamAScore').value) + 1, 4);   
});

document.getElementById('score-decrement-A').addEventListener('click', async () => {
    document.getElementById('teamAScore').value = Math.max(document.getElementById('teamAScore').value - 1, 0);
});

document.getElementById('score-increment-B').addEventListener('click', async () => {
    document.getElementById('teamBScore').value = Math.min(parseInt(document.getElementById('teamBScore').value) + 1, 4);
});

document.getElementById('score-decrement-B').addEventListener('click', async () => {
    document.getElementById('teamBScore').value = Math.max(document.getElementById('teamBScore').value - 1, 0);
});


// Handle result button click to add/update game history via API
document.getElementById('resultButton').addEventListener('click', async () => {
    const matchNumber = document.getElementById('matchNumber').value;
    const winType = document.getElementById('winType').value;
    var mapscore = "";

    const teamA = matchJSON.teams[0];
    const teamB = matchJSON.teams[1];
    var winner = [];
    if ( winType == "TIME1" || winType == "OBJ1" ){
        winner = teamA;
        mapscore = "1:0";
    }
    else {
        winner = teamB;
        mapscore = "0:1";
    }

    if (document.getElementById('attack').value == 2){
        mapscore = `${document.getElementById('teamAScore').value}:${document.getElementById('teamBScore').value}`;
    }

    console.log(document.getElementById('teamAScore').value);
    console.log(document.getElementById('teamBScore').value);

    const gameResult = {
        match_number: parseInt(matchNumber),
        map_name: tournamentData.maps.find(map => map.id === document.getElementById('currentMap').value).name,
        winning_team_name: winner.name,
        winning_team_id: winner.id,
        win_type: winType,
        map_score: mapscore
    };

    const response = await apiRequest('POST', '/result', gameResult);

    fetchMatches(); // Refresh the match table after adding result
});

// Handle result button click to add/update game history via API
document.getElementById('to_home').addEventListener('click', async () => {
    document.location = "/"
});

document.getElementById('bans').addEventListener('click', async () => {
            document.location = "/ban"
});

/*
document.getElementById('to_scoreboard').addEventListener('click', async () => {
    document.location = "http://localhost:5000/lite"
}); 
*/

const populateControls = (matchData) => {
    // Match Type
    const matchTypeSelect = document.getElementById('matchType');
    matchTypeSelect.value = matchData.match_type;

    // Match Number
    const matchNumberSelect = document.getElementById('matchNumber');
    matchNumberSelect.value = matchData.match_no;

    // Current Map
    const currentMapSelect = document.getElementById('currentMap');
    currentMapSelect.value = matchData.current_map;

    // Team on Attack
    const attackSelect = document.getElementById('attack');
    attackSelect.value = matchData.attack;

    // Team A
    const teamASelect = document.getElementById('teamA');
    teamASelect.value = matchData.teams[0].id;

    // Team B
    const teamBSelect = document.getElementById('teamB');
    teamBSelect.value = matchData.teams[1].id;

    // Team A Score
    const teamAScoreSelect = document.getElementById('teamAScore');
    teamAScoreSelect.value = matchData.teams[0].score;
//  document.getElementById("ScoreLabelA").innerText=`Team A score: ${matchData.teams[0].score}`;

    // Team B Score
    const teamBScoreSelect = document.getElementById('teamBScore');
    teamBScoreSelect.value = matchData.teams[1].score;

    const ShortNamesSelect = document.getElementById("short_names");
    ShortNamesSelect.checked = matchData.short_names;

    const SwapSelect = document.getElementById("swap");
    SwapSelect.checked = matchData.swap;
//  document.getElementById("ScoreLabelA").innerText=`Team B score: ${matchData.teams[1].score}`;
};

// Fetch data and populate the page on load

loadTournamentData();
fetchMatchData();

</script>

</body>
</html>

